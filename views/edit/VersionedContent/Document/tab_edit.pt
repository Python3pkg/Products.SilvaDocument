<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:notal="http://www.infrae.com/silva/notal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  i18n:domain="silva_document"
  tal:define="
    global vein string:editor;
    member python:here.service_members.get_member(here.REQUEST.AUTHENTICATED_USER.getUserName());
    editor python: member and member.editor() or 'forms_editor';
    refresh_time python:19 * 60;
    model request/model;
    is_editable model/get_unapproved_version;
    "
  >

<metal:block use-macro="here/macro_tab_edit/macros/editor">

<metal:block fill-slot="editor_css">
<tal:condition condition="is_editable">
<link href="globals/widgetEditor.css"
  rel="stylesheet"
  tal:condition="python: editor != 'kupu'"
  tal:attributes="href string:${root_url}/globals/widgetEditor.css"
/>
<link href="kupustyles.css"
  type="text/css"
  rel="stylesheet"
  tal:condition="python:editor == 'kupu'"
  tal:attributes="href string:${model/absolute_url}/edit/kupustyles.css"
/>
</tal:condition>
</metal:block>

<tal:block condition="nothing"> _______ refresh code for session timeout _______ </tal:block>
<metal:block fill-slot="editor_refresher">
<tal:condition condition="python: is_editable and editor != 'kupu' and refresh_time > 0">
<noscript>
<meta http-equiv="refresh" 
  tal:attributes="content python:'%s, %s/edit/tab_preview' % (refresh_time, request['model'].absolute_url())" />
</noscript>
<script type="text/javascript"
  tal:define="destination_path string:${request/model/absolute_url}/edit/"
  tal:content="string:

  document.timeout = '${refresh_time}'; 
  document.refresh_url = '${destination_path}tab_preview';
  document.prompt_url = '${destination_path}promptWindow';
" />
<script type="text/javascript" tal:condition="python:editor != 'kupu'">
  function handleTimeout()
  {
    if (document.promptWindow)
    {
      document.promptWindow.close();
    }
    loc = document.location.toString();
    editurl = loc.substring(0, loc.indexOf('/edit/'));
    document.location = document.refresh_url;
  }
  function setAutoSave(submit)
  {
    if (! document.autoSaveFormSubmit)
    {
      document.autoSaveFormSubmit = document.getElementById('default_submit');
      setTimeout('savePrompt()', document.timeout * 1000 / 4 * 3, '');
    }
  }
  function savePrompt()
  {
    leftPos = screen.width / 2 - 175;
    topPos = screen.height / 2 - 100;
    document.promptWindow = window.open(document.prompt_url, 'promptWindow', "height=175,width=300");
    document.promptWindow.focus();
  }
  function saveHelper()
  {
    document.autoSaveFormSubmit.click();
  }
  setTimeout('handleTimeout()', document.timeout * 1000, '');
</script>
 </tal:condition>
</metal:block>

<metal:block fill-slot="editor_selection">
<tal:block 
  define="active python: editor == 'kupu'"
  condition="python:hasattr(view, 'kupu')">
  <a title="edit with the Kupu Editor: alt-("
    accesskey="("
    i18n:translate=""
    tal:content="python: here.kupu_display(active)"
    tal:attributes="
      class python: test(active, 'selected', None);
      href python: '%s/edit?editor=kupu' % model.absolute_url()"
    i18n:attributes="title">
    </a>
  <div class="air"> </div>
  <a title="edit with the forms editor: alt-)"
    accesskey=")"
    i18n:translate=""
    tal:content="python: here.forms_editor_display(not active)"
    tal:attributes="
      class python: test(active, None, 'selected');
      href python: '%s/edit?editor=forms_editor' % model.absolute_url()"
    i18n:attributes="title">
  </a>
</tal:block>
</metal:block>

<metal:block fill-slot="editor_content">
<span tal:replace="nothing"> ______ forms editor ______ </span>
<tal:block condition="python:editor != 'kupu' or not hasattr(view, 'kupu')">
  <tal:block tal:replace="structure view/edit">Content</tal:block>
</tal:block>
<span tal:replace="nothing"> ______ kupu ______ </span>
<tal:block condition="python:editor == 'kupu' and hasattr(view, 'kupu')" >
  <metal:macro use-macro="view/kupu_silva/kupumacros/macros/fulleditor" />
</tal:block>
</metal:block>

</metal:block>
</html>
