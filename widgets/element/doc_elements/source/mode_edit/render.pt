<metal:block use-macro="container/macro_edit_view/macros/edit_view">
  <metal:block fill-slot="edit_input"
    tal:define="
      source here/get_source | nothing;
      source_id source/id | nothing;
      "
    >
    <div>
      source id&nbsp;<select name="id">
      <option disabled="disabled">Select an External Source...</option>
      <option 
        tal:repeat="av_source here/available_sources"
        tal:attributes="
          value av_source/id;
          title av_source/description;
          selected python: (source_id == av_source.id) and 'selected' or nothing;
          ">
          <span tal:replace="structure av_source/id" />
          <tal:block tal:condition="av_source/get_title" 
          tal:replace="structure string:&#34;${av_source/get_title}&#34;" />
        </option>
      </select>
      &nbsp;
      <input class="button" type="submit" value=" update " title="access key: alt-u" accesskey="u"
        tal:attributes="name string:${rel_url_start}/save:method" />
    </div>
    <tal:block condition="source">
      <div
        tal:define="
          form source/form | nothing;
          fields form/get_fields | nothing;
          has_parameters python: form and fields;
          current_parameters here/get_parameters;
          "
        >
        <b tal:condition="not: has_parameters">
          No parameters to be filled for this source.
        </b>
        <table class="csvtable" cellspacing="0" cellpadding="2" border="0" width="100%"
          tal:condition="has_parameters"
          >
          <thead>
            <tr>
              <th colspan="3">
                <b>Source parameters</b>
              </th>
            </tr>
          </thead>
          <tbody>
            <tal:block repeat="field fields">
              <tr 
                tal:define="
                  iterate repeat/field/odd;
                  id field/id;
                  title python: field['title'] or nothing;
                  description python: field['description'] or nothing;
                  is_required field/is_required | nothing;
                  current_value current_parameters/?id | nothing;
                  "
                tal:attributes="class python: iterate and 'odd' or 'even'"
                >
                <td class="align-right">
                  <span tal:replace="title">
                    title
                  </span><span class="warning" tal:condition="is_required">*</span>
                </td>
                <td tal:content="structure python: field.render(value=current_value)" />
                <td tal:content="description" />
              </tr>
            </tal:block>
          </tbody>
        </table>
      </div></tal:block>
  </metal:block>

  <metal:block fill-slot="edit_notes"
  tal:define="source here/get_source | nothing;
    source_desc source/description | nothing">
    <ul class="tips">
      <li>
      Select a source from the pulldown list.
      </li>
      <li>
      <span class="warning">Hit "update" to refresh the reference.</span>
      </li>
      <li>
        Fill in the parameters (if necessary).
      </li>
    </ul>

    <b tal:condition="source_desc">Source description:</b>
    <span tal:content="source_desc" />
  </metal:block>
</metal:block>
